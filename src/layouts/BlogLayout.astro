---
import { Image } from "astro:assets";

import type { CollectionEntry } from "astro:content";

import { CalendarDaysIcon, TagIcon, TimerIcon } from "lucide-react";

import AuthorInfo from "@/components/Blog/AuthorInfo.astro";
import Breadcrumb from "@/components/Blog/Breadcrumb.astro";
import ShareButtons from "@/components/Blog/ShareButtons.astro";
import TableOfContents from "@/components/Blog/TableOfContents";
import { calculateReadingTime, formatDate } from "@/lib/utils";

type Props = {
  post: CollectionEntry<"blog">;
};

const { post } = Astro.props;
const { Content, headings } = await post.render();
const readingTime = calculateReadingTime(post.body);
---

<div class="py-6 md:py-12 px-2">
  <Breadcrumb
    items={[
      { name: "ホーム", url: "/" },
      { name: "ブログ", url: "/blog" },
      { name: post.data.title, url: `/blog/${post.slug}` },
    ]}
  />
  <div class="grid grid-cols-12 gap-8 md:px-8">
    {/* SNS共有ボタン - PC左サイド */}
    <aside class="hidden md:col-span-2 md:block">
      <div class="sticky top-20">
        <ShareButtons title={post.data.title} slug={post.slug} />
      </div>
    </aside>

    {/* 記事コンテンツ */}
    <main class="col-span-12 md:col-span-7">
      <article
        class="prose dark:prose-invert prose-a:text-primary prose-a:hover:text-primary/80 prose-p:text-justify prose-img:rounded-xl max-w-none"
      >
        <h1
          class="text-3xl border-b-4 pb-2"
          transition:name={`blog-title-${post.slug}`}
        >
          {post.data.title}
        </h1>

        <div
          class="flex items-center justify-between gap-4 text-muted-foreground"
        >
          <div class="flex items-center gap-2">
            <CalendarDaysIcon size={16} />
            <time datetime={post.data.pubDate.toISOString()}>
              {formatDate(post.data.pubDate)}
            </time>
          </div>
          <div class="flex items-center gap-1">
            <TimerIcon size={16} />
            約{readingTime}分で読めます
          </div>
        </div>

        {
          post.data.tags && post.data.tags.length > 0 && (
            <div class="not-prose flex flex-wrap items-center gap-2 mt-3">
              <TagIcon size={14} className="text-muted-foreground shrink-0" />
              {post.data.tags.map((tag) => (
                <a
                  href={`/blog/${tag}`}
                  class="inline-block px-1 py-0.5 bg-primary/20 text-primary border border-primary text-xs
                         transition-colors duration-150 hover:bg-primary/40"
                >
                  #{tag}
                </a>
              ))}
            </div>
          )
        }

        {
          post.data.topImage && (
            <figure transition:name={`blog-image-${post.slug}`}>
              <Image
                class="w-full h-auto rounded-lg mb-8"
                src={post.data.topImage}
                alt={post.data.title}
                width={1280}
                height={720}
                loading="eager"
                decoding="async"
              />
            </figure>
          )
        }

        {/* モバイル用目次 */}
        <div class="md:hidden mb-8">
          <TableOfContents client:load headings={headings} isMobile={true} />
        </div>

        {/* 記事本文 */}
        <div transition:animate="fade">
          <Content />
        </div>
      </article>

      <div class="my-12 flex items-center justify-center not-prose">
        <span class="h-1 bg-border w-full"></span>
      </div>

      <AuthorInfo />

      <div
        class="md:hidden mt-8 p-6 border-4 border-card-foreground bg-card sm:shadow-[8px_8px_0_0]"
      >
        <div class="flex flex-wrap items-center gap-4">
          <ShareButtons title={post.data.title} slug={post.slug} />
        </div>
      </div>
    </main>
    {/* 目次 - PC右サイド */}
    <aside class="hidden md:col-span-3 md:block">
      <div class="sticky top-20 space-y-4">
        <TableOfContents client:load headings={headings} />
      </div>
    </aside>
  </div>
</div>
